<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="src/css/paginaperfiledicao.css">
    <title>Segue o Festival</title>
</head>
<body>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const usuarioLogado = localStorage.getItem("usuarioLogado");
    
        if (!usuarioLogado) {
          window.location.href = "login.html";
          return;
        }
    
        try {
          const dados = JSON.parse(usuarioLogado);
          if (!dados.email) {
            window.location.href = "login.html";
          }
        } catch (erro) {
          window.location.href = "login.html";
        }
      });
    </script>
    <header>
    <nav id="sidebar" class="open-sidebar">
        <div id="sidebar_content">
            <div id="user">
                <img src="src/images/avatar.avif" id="user_avatar" alt="Avatar">
    
                <p id="user_infos">
                    <span class="item-description">
                    </span>
                </p>
            </div>
    
            <ul id="side_items">
                <li class="side-item">
                    <a href="https://segue-o-festival.vercel.app/home.html">
                        <i class="fa-solid fa-house"></i>
                        <span class="item-description">
                            Home
                        </span>
                    </a>
                </li>

                <li class="side-item active">
                    <a href="#">
                        <i class="fa-solid fa-user"></i>
                        <span class="item-description">
                            Perfil
                        </span>
                    </a>
                </li>
    
                <li class="side-item">
                    <a href="eventossalvos.html">
                        <i class="fa-solid fa-star"></i>
                        <span class="item-description">
                            Meus Eventos
                        </span>
                    </a>
                </li>
            </ul>
        </div>

        <div id="logout">
            <button id="logout_btn">
                <i class="fa-solid fa-right-from-bracket"></i>
                <span class="item-description">
                    Logout
                </span>
            </button>
        </div>
    </nav>
</header>


    <main>        
        <h1 class="cabecalho-titulo">Segue<br>O Festival</h1>

        <section class="conteudo-formulario">
            <div class="dados-pessoais-informacoes">
                <h2 class="subtitulo">Dados Pessoais</h2>
                <i class="fa-solid fa-pen"></i>
                <div class="dados-pessoais-nome">
                <p>Nome Completo</p>
                <input class="dados-pessoais-nome-formulario" type="text" id="txtNome" placeholder="Nome Completo">
                </div>
    
                <div class="dados-pessoais-baixo">
                <div class="dados-pessoais-telefone">
                    <p>CPF</p>
                    <input class="dados-pessoais-telefone-formulario" type="tel" id="telCPF" placeholder="000.000.000-00" readonly>
                </div>
                <div class="dados-pessoais-telefone">
                    <p>Telefone</p>
                    <input class="dados-pessoais-telefone-formulario" type="tel" id="telTelefone" placeholder="(00) 00000-0000">
                </div>    
    
                <div class="dados-pessoais-datanascimento">
                    <p>Data de Nascimento</p>
                    <input class="dados-pessoais-datanascimento-formulario" type="text" id="dateNascimento" placeholder="dd/mm/aaaa">
                </div>
    
                <div class="dados-pessoais-sexo">
                    <p>Sexo</p>
                    <input class="dados-pessoais-sexo-formulario" type="text" id="sexo" placeholder="Feminino, Masculino ou Não informar">
                </div>
                </div>
            </div>
    
            <div class="dados-pessoais-morada">
                <div class="dados-pessoais-endereco">
                    <h2 class="subtitulo">Endereço</h2>
                    <i class="fa-solid fa-pen"></i>
                    <p>Endereço</p>
                    <input class="dados-pessoais-endereco-formulario" type="text" id="txtEndereço" placeholder="Insira o Endereço">
                </div>
    
                <div class="dados-endereco-abaixo">
                <div class="dados-pessoais-cep">
                    <p>CEP</p>
                    <input class="dados-pessoais-cep-formulario" type="tel" id="telCEP" placeholder="00000-000">
                </div>
    
                <div class="dados-pessoais-numero">
                    <p>Número</p>
                    <input class="dados-pessoais-numero-formulario" type="tel" id="telNum" placeholder="Número da Residência">
                </div>
    
                <div class="dados-pessoais-complemento">
                    <p>Complemento</p>
                    <input class="dados-pessoais-complemento-formulario" type="tel" id="telCom" placeholder="Complemento">
                </div>
                </div>
    
                <div class="dados-endereco-abaixo-secundario">
                <div class="dados-pessoais-municipio">
                    <p>Município</p>
                    <input class="dados-pessoais-municipio-formulario" type="text" id="municipio" placeholder="Nome do Município">
                </div>
                    
    
                <div class="dados-pessoais-uf">
                    <p>UF</p>
                    <input class="dados-pessoais-uf-formulario" type="text" id="uf" placeholder="Sigla do Estado (ex: SP)">
                </div>
                </div>
            </div>
    
            
            <div class="dados-pessoais-usuario">
                <h2 class="subtitulo-pen">
                    Login <i class="fa-solid fa-pen"></i>
                </h2>
                <div class="dados-pessoais-email">
                    <p>E-mail</p>
                    <input class="dados-pessoais-email-formulario" type="email" id="emailEm" placeholder="E-mail" readonly>
                </div>
            
                <div class="dados-pessoais-senha">
                    <h3>Alterar Senha (opcional)</h3>
                    
                    <div class="campo-senha">
                        <p>Nova Senha:</p>
                        <input class="dados-pessoais-senha-formulario" type="password" id="novaSenha" placeholder="Deixe em branco para não alterar">
                    </div>
                    
                    <div class="campo-senha">
                        <p>Confirmar Nova Senha:</p>
                        <input class="dados-pessoais-senha-formulario" type="password" id="confirmarSenha" placeholder="Confirme a nova senha">
                    </div>

                    <div class="campo-senha">
                        <p>Confirmação (digite sua senha atual):</p>
                        <input class="dados-pessoais-senha-formulario" type="password" id="senhaAtual" placeholder="Obrigatório para confirmar alterações" required>
                    </div>
                </div>
            </div> 

            <div>
                <button class="botao-salvar" onclick="salvarPerfil()">Salvar</button>
            </div>
    
            </section>

          
             
        <footer class="rodape">
            <h3 class="titulo-rodape">Segue<br>O Festival!</h3>           
            </div>           
            <div class="direitos-reservados">
              &copy; 2025 Segue o Festival. Todos os direitos reservados.
            </div>            
          </footer>
          
    </main>

    <script>
        // Funções auxiliares para formatação
        function formatarCPF(cpf) {
            cpf = cpf.replace(/\D/g, '');
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        function formatarTelefone(telefone) {
            telefone = telefone.replace(/\D/g, '');
            if (telefone.length === 11) {
                return telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return telefone;
        }
        
        function formatarCEP(cep) {
            cep = cep.replace(/\D/g, '');
            return cep.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        // Função para converter data brasileira (dd/mm/aaaa) para o formato do banco (mmmm/aa/dd)
        function formatarDataParaBanco(dataBr) {
            if (!dataBr) return null;
            
            const [dia, mes, ano] = dataBr.split('/');
            const meses = [
                'janeiro', 'fevereiro', 'março', 'abril', 'maio', 'junho',
                'julho', 'agosto', 'setembro', 'outubro', 'novembro', 'dezembro'
            ];
            
            const nomeMes = meses[parseInt(mes) - 1];
            const anoAbreviado = ano.slice(-2);
            
            return `${nomeMes}/${anoAbreviado}/${dia}`;
        }

        // Carregar dados do usuário ao abrir a página
        document.addEventListener("DOMContentLoaded", async () => {
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            
            if (!usuarioLogado) {
                window.location.href = "login.html";
                return;
            }
            
            // Preencher nome do usuário na sidebar
            const nomeUsuario = document.querySelector("#user_infos .item-description");
            if (nomeUsuario) {
                nomeUsuario.textContent = `Olá, ${usuarioLogado.nome || "Usuário"}!`;
            }
            
            try {
                // Buscar dados do usuário na API
                const response = await fetch(`/api/usuario?email=${encodeURIComponent(usuarioLogado.email)}`);
                
                if (!response.ok) {
                    throw new Error(await response.text());
                }
                
                const dados = await response.json();
                
                // Preencher os campos do formulário
                document.getElementById("txtNome").value = dados.nome || "";
                document.getElementById("telCPF").value = formatarCPF(dados.cpf || "");
                document.getElementById("telTelefone").value = formatarTelefone(dados.telefone || "");
                document.getElementById("emailEm").value = dados.email || dados.email_usuario || "";
                
                // Preencher os demais campos
                if (dados.sexo) document.getElementById("sexo").value = dados.sexo;
                if (dados.endereco) document.getElementById("txtEndereço").value = dados.endereco;
                if (dados.cep) document.getElementById("telCEP").value = formatarCEP(dados.cep);
                if (dados.numero) document.getElementById("telNum").value = dados.numero;
                if (dados.complemento) document.getElementById("telCom").value = dados.complemento;
                if (dados.municipio) document.getElementById("municipio").value = dados.municipio;
                if (dados.uf) document.getElementById("uf").value = dados.uf;
                
                // Adicionar máscaras aos campos
                document.getElementById("telCPF").addEventListener("input", function(e) {
                    e.target.value = formatarCPF(e.target.value);
                });
                
                document.getElementById("telTelefone").addEventListener("input", function(e) {
                    e.target.value = formatarTelefone(e.target.value);
                });
                
                document.getElementById("telCEP").addEventListener("input", function(e) {
                    e.target.value = formatarCEP(e.target.value);
                });
                
            } catch (error) {
                console.error("Erro ao carregar perfil:", error);
                alert("Erro ao carregar dados do perfil: " + error.message);
            }
        });

        // Função principal para salvar o perfil
        async function salvarPerfil() {
            const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
            
            // Verificar senha atual (obrigatória para qualquer alteração)
            const senhaAtual = document.getElementById("senhaAtual").value;
            if (!senhaAtual) {
                alert("Por favor, digite sua senha atual para confirmar as alterações");
                return;
            }

            // Coletar todos os dados do formulário
            const dadosAtualizados = {
                nome: document.getElementById("txtNome").value,
                cpf: document.getElementById("telCPF").value.replace(/\D/g, ''),
                data_nascimento: formatarDataParaBanco(document.getElementById("dateNascimento").value),
                sexo: document.getElementById("sexo").value,
                endereco: document.getElementById("txtEndereço").value,
                cep: document.getElementById("telCEP").value.replace(/\D/g, ''),
                numero: document.getElementById("telNum").value,
                complemento: document.getElementById("telCom").value,
                municipio: document.getElementById("municipio").value,
                uf: document.getElementById("uf").value,
                email: document.getElementById("emailEm").value,
                senha_atual: senhaAtual
            };

            // Verificar se o usuário quer alterar a senha
            const novaSenha = document.getElementById("novaSenha").value;
            const confirmarSenha = document.getElementById("confirmarSenha").value;
            
            // Só valida a senha se ambos os campos estiverem preenchidos
            if (novaSenha && confirmarSenha) {
                if (novaSenha !== confirmarSenha) {
                    alert("As novas senhas não coincidem");
                    return;
                }
                
                // Aplica regras de validação apenas se estiver alterando a senha
                const senhaRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?#&])[A-Za-z\d@$!%*?#&]{8,}$/;
                if (!senhaRegex.test(novaSenha)) {
                    alert("A nova senha deve ter no mínimo 8 caracteres, com pelo menos uma letra maiúscula, uma minúscula, um número e um caractere especial");
                    return;
                }
                
                dadosAtualizados.nova_senha = novaSenha;
            } else if ((novaSenha && !confirmarSenha) || (!novaSenha && confirmarSenha)) {
                alert("Por favor, preencha ambos os campos de senha se desejar alterá-la");
                return;
            }

            try {
                // Chamada para sua API para atualizar os dados
                const response = await fetch('/api/usuario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dadosAtualizados)
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.message || 'Erro ao atualizar perfil');
                }
                
                // Atualizar dados no localStorage
                const usuarioAtualizado = {
                    ...usuarioLogado,
                    nome: dadosAtualizados.nome,
                    email: dadosAtualizados.email
                };
                
                if (novaSenha) {
                    usuarioAtualizado.senha = novaSenha;
                }
                
                localStorage.setItem("usuarioLogado", JSON.stringify(usuarioAtualizado));
                
                // Atualizar nome na sidebar
                const nomeUsuario = document.querySelector("#user_infos .item-description");
                if (nomeUsuario) {
                    nomeUsuario.textContent = `Olá, ${dadosAtualizados.nome || "Usuário"}!`;
                }
                
                alert("Perfil atualizado com sucesso!");
                
                // Limpar campos de senha
                document.getElementById("novaSenha").value = "";
                document.getElementById("confirmarSenha").value = "";
                document.getElementById("senhaAtual").value = "";
                
            } catch (error) {
                console.error("Erro:", error);
                alert("Erro ao atualizar perfil: " + error.message);
            }
        }
    </script>
</body>
</html>
