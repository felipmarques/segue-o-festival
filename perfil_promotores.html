<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="src/css/paginaperfiledicao.css">
    <title>Segue o Festival</title>
</head>
<body>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const usuarioLogado = localStorage.getItem("usuarioLogado");
    
        if (!usuarioLogado) {
          window.location.href = "loginPromotor.html";
          return;
        }
    
        try {
          const dados = JSON.parse(usuarioLogado);
          if (!dados.email) throw new Error();
        } catch (erro) {
          window.location.href = "loginPromotor.html";
        }
      });
    </script>
    
    <header>
        <nav id="sidebar" class="open-sidebar">
            <div id="sidebar_content">
                <div id="user">
                    <img src="src/images/avatar.avif" id="user_avatar" alt="Avatar">
        
                    <p id="user_infos">
                        <span class="item-description">
                        </span>
                    </p>
                </div>
        
                <ul id="side_items">
                    <li class="side-item">
                        <a href="https://segue-o-festival.vercel.app/home.html">
                            <i class="fa-solid fa-house"></i>
                            <span class="item-description">
                                Home
                            </span>
                        </a>
                    </li>

                    <li class="side-item active">
                        <a href="#">
                            <i class="fa-solid fa-user"></i>
                            <span class="item-description">
                                Perfil
                            </span>
                        </a>
                    </li>
        
                    <li class="side-item">
                        <a href="meusEventosPromotor.html">
                            <i class="fa-solid fa-star"></i>
                            <span class="item-description">
                                Meus Eventos
                            </span>
                        </a>
                    </li>
                </ul>
            </div>

            <div id="logout">
                <button id="logout_btn">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    <span class="item-description">
                        Logout
                    </span>
                </button>
            </div>
        </nav>
    </header>

    <main>        
        <h1 class="cabecalho-titulo">Segue<br>O Festival</h1>

        <section class="conteudo-formulario">
            <div class="dados-pessoais-informacoes">
                <h2 class="subtitulo">Dados Pessoais</h2>
                <i class="fa-solid fa-pen"></i>
                <div class="dados-pessoais-nome">
                <p>Nome Completo da Empresa</p>
                <input class="dados-pessoais-nome-formulario" type="text" id="txtNome" placeholder="Nome Completo"/>
                </div>
    
                <div class="dados-pessoais-baixo">
                <div class="dados-pessoais-telefone">
                    <p>CNPJ</p>
                    <input class="dados-pessoais-telefone-formulario" type="tel" id="txtCNPJ" placeholder="Insira seu CNPJ">
                </div>
                <div class="dados-pessoais-telefone">
                    <p>Telefone</p>
                    <input class="dados-pessoais-telefone-formulario" type="tel" id="telTelefone" placeholder="(00) 00000-0000">
                </div>    
    
            <div class="dados-pessoais-morada">
                <div class="dados-pessoais-endereco">
                    <h2 class="subtitulo">Endereço</h2>
                    <i class="fa-solid fa-pen"></i>
                    <p>Endereço</p>
                    <input class="dados-pessoais-endereco-formulario" type="text" id="txtEndereço" placeholder="Insira o Endereço"/>
                </div>
    
                <div class="dados-endereco-abaixo" >
                <div class="dados-pessoais-cep">
                    <p>CEP</p>
                    <input class="dados-pessoais-cep-formulario" type="tel" id="telCEP" placeholder="CEP">
                </div>
    
                <div class="dados-pessoais-numero">
                    <p>Número</p>
                    <input class="dados-pessoais-numero-formulario" type="tel" id="telNum" placeholder="Número da Residência">
                </div>
    
                <div class="dados-pessoais-complemento" >
                    <p>Complemento</p>
                    <input class="dados-pessoais-complemento-formulario" type="tel" id="telCom" placeholder="Complemento">
                </div>
                </div>
    
                <div class="dados-endereco-abaixo-secundario" >
                <div class="dados-pessoais-municipio" >
                    <p>Município</p>
                    <select class="dados-pessoais-municipio-formulario" id="municipio" name="municipio">
                    <option value="americana">Americana</option>
                    <option value="barueri">Barueri</option>
                    <option value="braganca_paulista">Bragança Paulista</option>
                    <option value="cajamar">Cajamar</option>
                    <option value="campinas">Campinas</option>
                    <option value="carapicuiba">Carapicuíba</option>
                    <option value="diadema">Diadema</option>
                    <option value="embu_das_artes">Embu das Artes</option>
                    <option value="guaruja">Guarujá</option>
                    <option value="hortolandia">Hortolândia</option>
                    <option value="itatiba">Itatiba</option>
                    <option value="itapecerica_da_serra">Itapecerica da Serra</option>
                    <option value="jundiai">Jundiaí</option>
                    <option value="maua">Mauá</option>
                    <option value="osasco">Osasco</option>
                    <option value="piracicaba">Piracicaba</option>
                    <option value="praia_grande">Praia Grande</option>
                    <option value="ribeirao_pires">Ribeirão Pires</option>
                    <option value="rio_grande_da_serra">Rio Grande da Serra</option>
                    <option value="santana_de_parnaiba">Santana de Parnaíba</option>
                    <option value="santo_andre">Santo André</option>
                    <option value="santos">Santos</option>
                    <option value="sao_bernardo">São Bernardo do Campo</option>
                    <option value="sao_caetano">São Caetano do Sul</option>
                    <option value="sao_jose_dos_campos">São José dos Campos</option>
                    <option value="sao_paulo">São Paulo</option>
                    <option value="sorocaba">Sorocaba</option>
                    <option value="sumare">Sumaré</option>
                    <option value="taubate">Taubaté</option>
                    <option value="taboao_da_serra">Taboão da Serra</option>
                    </select>
                </div>
                </div>
            </div>
    
            <div class="dados-pessoais-usuario">
                <h2 class="subtitulo-pen">
                    Login <i class="fa-solid fa-pen"></i>
                </h2>
                <div class="dados-pessoais-email">
                    <p>E-mail</p>
                    <input class="dados-pessoais-email-formulario" type="email" id="emailEm" placeholder="E-mail" readonly/>
                </div>
            
                <div class="dados-pessoais-senha">
                    <h3>Alterar Senha</h3>
                    
                    <div class="campo-senha">
                        <p>Nova Senha:</p>
                        <input class="dados-pessoais-senha-formulario" type="password" id="novaSenha" placeholder="Digite a nova senha">
                    </div>
                    
                    <div class="campo-senha">
                        <p>Confirmar Senha:</p>
                        <input class="dados-pessoais-senha-formulario" type="password" id="confirmarSenha" placeholder="Confirme a nova senha">
                    </div>
                </div>
            </div> 

            <div>
                <button class="botao-salvar" onclick="salvarPerfil()">Salvar</button>
            </div>
        </section>

        <footer class="rodape">
            <h3 class="titulo-rodape">Segue<br>O Festival!</h3>           
            </div>           
            <div class="direitos-reservados">
              &copy; 2025 Segue o Festival. Todos os direitos reservados.
            </div>            
        </footer>
    </main>

    <script>
        // Funções de formatação seguras
        function formatarCNPJSeguro(cnpj) {
            if (!cnpj) return '';
            const apenasNumeros = cnpj.replace(/\D/g, '');
            return apenasNumeros.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
        }
        
        function formatarTelefoneSeguro(telefone) {
            if (!telefone) return '';
            const apenasNumeros = telefone.replace(/\D/g, '');
            if (apenasNumeros.length === 11) {
                return apenasNumeros.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            }
            return telefone;
        }
        
        function formatarCEPSeguro(cep) {
            if (!cep) return '';
            const apenasNumeros = cep.replace(/\D/g, '');
            return apenasNumeros.replace(/(\d{5})(\d{3})/, '$1-$2');
        }

        // Função de Logout
        function fazerLogout() {
            const btn = document.getElementById("logout_btn");
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saindo...';
            btn.disabled = true;
            
            localStorage.removeItem("usuarioLogado");
            localStorage.removeItem("token");
            localStorage.removeItem("authToken");
            
            setTimeout(() => {
                window.location.href = "index.html";
                history.pushState(null, null, "index.html");
                window.addEventListener('popstate', function() {
                    history.pushState(null, null, "index.html");
                });
            }, 500);
        }

        // Carregar dados do perfil
        document.addEventListener("DOMContentLoaded", async () => {
            console.log("DOM totalmente carregado.");
        
            const usuarioLogadoRaw = localStorage.getItem("usuarioLogado");
            if (!usuarioLogadoRaw) {
                console.warn("Usuário não logado. Redirecionando...");
                window.location.href = "loginPromotor.html";
                return;
            }
        
            let usuarioLogado;
            try {
                usuarioLogado = JSON.parse(usuarioLogadoRaw);
                if (!usuarioLogado.email) throw new Error();
            } catch (e) {
                console.error("Erro ao analisar os dados do usuário logado:", e);
                window.location.href = "loginPromotor.html";
                return;
            }
        
            // Atualizar nome do usuário na sidebar
            const nomeUsuario = document.querySelector("#user_infos .item-description");
            if (nomeUsuario) {
                nomeUsuario.textContent = `Olá, ${usuarioLogado.nome_responsavel || "Usuário"}!`;
            }
        
            // Carregar dados do promotor
            try {
                console.log("Buscando dados do promotor para:", usuarioLogado.email);
                const response = await fetch(`/api/buscarPromotor?email=${encodeURIComponent(usuarioLogado.email)}`);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`);
                }
                
                const { data } = await response.json();
                console.log("Dados recebidos:", data);
        
                // Preencher formulário com tratamento para valores nulos
                document.getElementById("txtNome").value = data.nome_responsavel || "Não informado";
                document.getElementById("txtCNPJ").value = formatarCNPJSeguro(data.cnpj);
                document.getElementById("telTelefone").value = formatarTelefoneSeguro(data.telefone);
                document.getElementById("emailEm").value = data.email || "Não informado";
                document.getElementById("txtEndereço").value = data.endereco || "Não informado";
                document.getElementById("telCEP").value = formatarCEPSeguro(data.cep);
                document.getElementById("telNum").value = data.numero || "";
                document.getElementById("telCom").value = data.complemento || "";
                if (data.municipio) document.getElementById("municipio").value = data.municipio;
        
            } 
        
            // Configurar evento de logout
            document.getElementById("logout_btn")?.addEventListener("click", fazerLogout);
        
            // Configurar salvamento do perfil
            document.querySelector('.botao-salvar')?.addEventListener('click', async () => {
                console.log("Iniciando salvamento do perfil...");
        
                const senha = document.getElementById("novaSenha").value;
                const confirmarSenha = document.getElementById("confirmarSenha").value;
        
                if (senha && senha !== confirmarSenha) {
                    alert("As senhas não coincidem!");
                    return;
                }
        
                const dadosAtualizados = {
                    nome_responsavel: document.getElementById("txtNome").value,
                    cnpj: document.getElementById("txtCNPJ").value.replace(/\D/g, ''),
                    telefone: document.getElementById("telTelefone").value.replace(/\D/g, ''),
                    endereco: document.getElementById("txtEndereço").value,
                    cep: document.getElementById("telCEP").value.replace(/\D/g, ''),
                    numero: document.getElementById("telNum").value,
                    complemento: document.getElementById("telCom").value,
                    municipio: document.getElementById("municipio").value
                };
        
                if (senha) dadosAtualizados.senha = senha;
        
                try {
                    console.log("Enviando dados atualizados:", dadosAtualizados);
                    const response = await fetch(`/api/buscarPromotor?email=${encodeURIComponent(usuarioLogado.email)}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(dadosAtualizados)
                    });
                
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`);
                    }
                
                    const resultado = await response.json();
                    console.log("Perfil atualizado:", resultado);
                    
                    // Atualizar dados no localStorage
                    usuarioLogado.nome_responsavel = dadosAtualizados.nome_responsavel;
                    localStorage.setItem("usuarioLogado", JSON.stringify(usuarioLogado));
                    
                    // Atualizar nome na sidebar
                    if (nomeUsuario) {
                        nomeUsuario.textContent = `Olá, ${usuarioLogado.nome_responsavel || "Usuário"}!`;
                    }
                    
                    alert("Perfil atualizado com sucesso!");
                
                } catch (error) {
                    console.error("Erro ao atualizar perfil:", error);
                    alert("Erro ao atualizar perfil: " + (error.message || "Erro desconhecido"));
                }
            });
        });
    </script>
    <div id="popupSucesso" style="display:none; position:fixed; top:20px; right:20px; background:#4caf50; color:#fff; padding:15px 25px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.3); z-index:1000;">
        Perfil atualizado com sucesso!
    </div>
</body>
</html>
