<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="src/css/eventossalvos.css" />
  <title>Meus Eventos Salvos | Segue o Festival</title>
  <style>
    /* Estilos adicionais para a versão completa */
    .conteudo-secundario-item {
      position: relative;
      margin-bottom: 20px;
    }
    
    .remove-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,0,0,0.7);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .remove-btn:hover {
      background: rgba(255,0,0,0.9);
    }
    
    .sem-eventos {
      text-align: center;
      padding: 40px;
      color: #666;
      font-size: 1.2em;
    }
    
    .erro-carregamento {
      text-align: center;
      padding: 40px;
      color: #d32f2f;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <header>
    <nav id="sidebar">
      <div id="sidebar_content">
        <div id="user">
          <img src="src/images/avatar.avif" id="user_avatar" alt="Avatar" />
          <p id="user_infos">
            <span class="item-description">Olá, Lorena!</span>
          </p>
        </div>

        <ul id="side_items">
          <li class="side-item"><a href="https://segue-o-festival.vercel.app/home.html"><i class="fa-solid fa-house"></i><span class="item-description">Home</span></a></li>
          <li class="side-item"><a href="https://segue-o-festival.vercel.app/perfil.html"><i class="fa-solid fa-user"></i><span class="item-description">Perfil</span></a></li>
          <li class="side-item active"><a href="#"><i class="fa-solid fa-star"></i><span class="item-description">Meus Eventos</span></a></li>
        </ul>

        <button id="open_btn">
          <i id="open_btn_icon" class="fa-solid fa-chevron-right"></i>
        </button>
      </div>

      <div id="logout">
        <button id="logout_btn">
          <i class="fa-solid fa-right-from-bracket"></i>
          <span class="item-description">Logout</span>
        </button>
      </div>
    </nav>
  </header>

  <main>
    <h1 class="cabecalho-titulo">Segue<br />O Festival</h1>

    <section class="conteudo-secundario">
      <div class="conteudo-secundario-destaque">
        <h1>Meus Eventos Salvos</h1>
        <a href="#">
          <div class="filtro">
            <i class="fa-solid fa-filter"></i>
          </div>
        </a>
      </div>

      <div class="conteudo-secundario-primeiralinha" id="eventosContainer">
        <!-- Eventos serão carregados dinamicamente aqui -->
      </div>
    </section>

    <div class="paginacao">
      <a href="#" class="ativo">1</a>
    </div>

    <footer class="rodape">
      <h3 class="titulo-rodape">Segue<br />O Festival!</h3>

      <div class="rodape-links">
        <div class="menu-hover">
          <div>
            <span class="rodape-direcionamento" onclick="toggleLista('listaEventos')">Encontre Eventos</span>
            <ul class="lista-escondida" id="listaEventos">
              <li>Festival A</li>
              <li>Festival B</li>
              <li>Festival C</li>
            </ul>
          </div>

          <div>
            <span class="rodape-direcionamento" onclick="toggleLista('listaCidades')">Cidades</span>
            <ul class="lista-escondida" id="listaCidades">
              <li>São Paulo</li>
              <li>Rio de Janeiro</li>
              <li>Belo Horizonte</li>
              <li>Curitiba</li>
            </ul>
          </div>

          <div>
            <span class="rodape-direcionamento" onclick="toggleLista('listaCategorias')">Categorias</span>
            <ul class="lista-escondida" id="listaCategorias">
              <li>Festival</li>
              <li>Show</li>
              <li>Religioso</li>
              <li>Carnaval</li>
              <li>Festa Junina</li>
              <li>Ano Novo</li>
            </ul>
          </div>

          <div>
            <span class="rodape-direcionamento" onclick="toggleLista('listaParaPromotores')">Para Promotores</span>
            <ul class="lista-escondida" id="listaParaPromotores">
              <li>Cadastrar Evento</li>
              <li>Contato</li>
            </ul>
          </div>

          <a href="https://cadastro-organizador.vercel.app/faq.html" class="rodape-direcionamento">Ajuda</a>
        </div>
      </div>

      <div class="direitos-reservados">
        &copy; 2025 Segue o Festival. Todos os direitos reservados.
      </div>
    </footer>
  </main>

  <script>
    // Função para alternar listas no footer
    function toggleLista(id) {
      const lista = document.getElementById(id);
      lista.style.display = lista.style.display === 'none' ? 'block' : 'none';
    }

    // Verifica se o usuário está logado
    const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
    if (!usuarioLogado) {
      window.location.href = "login.html";
    } else {
      // Atualiza o nome do usuário na sidebar
      const userInfos = document.getElementById("user_infos");
      if (userInfos) {
        userInfos.querySelector('.item-description').textContent = `Olá, ${usuarioLogado.nome || 'Usuário'}!`;
      }
    }

    // Logout
    document.getElementById('logout_btn').addEventListener('click', () => {
      localStorage.clear();
      window.location.href = 'login.html';
    });

    // Carrega os eventos salvos
    document.addEventListener("DOMContentLoaded", async () => {
      try {
        if (!usuarioLogado?.cpf) {
          document.getElementById("eventosContainer").innerHTML = `
            <div class="sem-eventos">
              <p>Você precisa estar logado para ver seus eventos salvos.</p>
              <a href="login.html" class="btn-login">Fazer Login</a>
            </div>
          `;
          return;
        }

        const response = await fetch(`/api/eventos-salvos-usuario?cpf=${encodeURIComponent(usuarioLogado.cpf)}`);
        
        if (!response.ok) {
          throw new Error(`Erro: ${response.status}`);
        }

        const eventos = await response.json();
        const container = document.getElementById("eventosContainer");

        if (eventos.length === 0) {
          container.innerHTML = `
            <div class="sem-eventos">
              <i class="fa-regular fa-star" style="font-size: 2em; margin-bottom: 15px;"></i>
              <p>Você ainda não salvou nenhum evento.</p>
              <a href="home.html" class="btn-explorar">Explorar Eventos</a>
            </div>
          `;
          return;
        }

        container.innerHTML = eventos.map(evento => `
          <div class="conteudo-secundario-item">
            <img class="conteudo-secundario-imagem" 
                 src="${evento.imagemUrl || 'src/images/default-event.jpg'}" 
                 alt="Banner ${evento.titulo}">
            <h3 class="conteudo-secundario-titulo">${evento.titulo}</h3>
            <p class="conteudo-secundario-paragrafo">
              <i class="fa-regular fa-calendar"></i> ${evento.data}
            </p>
            <p class="conteudo-secundario-paragrafo">
              <i class="fa-solid fa-location-dot"></i> ${evento.endereco}
            </p>
            <button class="remove-btn" data-id="${evento.id_evento}">
              <i class="fa-solid fa-trash"></i> Remover
            </button>
          </div>
        `).join('');

        // Adiciona eventos de clique para os botões de remoção
        document.querySelectorAll('.remove-btn').forEach(btn => {
          btn.addEventListener('click', async (e) => {
            const eventoId = e.currentTarget.getAttribute('data-id');
            try {
              const deleteResponse = await fetch('/api/eventos-salvos-usuario', {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                  eventoId, 
                  cpf: usuarioLogado.cpf 
                })
              });
              
              if (!deleteResponse.ok) {
                throw new Error('Falha ao remover evento');
              }
              
              // Recarrega a página para atualizar a lista
              window.location.reload();
            } catch (error) {
              console.error('Erro ao remover evento:', error);
              alert('Ocorreu um erro ao remover o evento. Tente novamente.');
            }
          });
        });

      } catch (error) {
        console.error("Erro ao carregar eventos salvos:", error);
        document.getElementById("eventosContainer").innerHTML = `
          <div class="erro-carregamento">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <p>Ocorreu um erro ao carregar seus eventos salvos.</p>
            <button onclick="window.location.reload()">Tentar novamente</button>
          </div>
        `;
      }
    });

    // Sidebar toggle
    const openBtn = document.getElementById('open_btn');
    const sidebar = document.getElementById('sidebar');

    openBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const icon = document.getElementById('open_btn_icon');
      icon.classList.toggle('fa-chevron-right');
      icon.classList.toggle('fa-chevron-left');
    });
  </script>
</body>
</html>
