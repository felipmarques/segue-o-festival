<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Segue o Festival</title>
  <link rel="stylesheet" href="estilo.css" />
</head>

<body>
  <header class="header">
    <div class="logo">Segue o Festival</div>
    <div class="nav-buttons">
      <a href="/faq.html" class="nav-button">FAQ</a>
      <a href="/perfil.html" class="nav-button">Perfil</a>
    </div>
  </header>

  <section class="filtros">
    <div class="filtro-bar">
      <div class="filtro-estado">
        <label>Estado:</label>
        <div class="estado-scroll" id="estadoContainer"></div>
      </div>

      <div class="filtro">
        <label for="tipoEvento">Tipo de Evento:</label>
        <select id="tipoEvento"></select>
      </div>

      <div class="filtro">
        <label for="nomeEvento">Pesquise seus eventos:</label>
        <input type="text" id="nomeEvento" placeholder="Nome do evento" />
      </div>

      <div class="filtro">
        <label for="localEvento">Busca por local:</label>
        <input type="text" id="localEvento" placeholder="Cidade ou local do evento" />
      </div>

      <div class="filtro">
        <label for="dataEvento">Data:</label>
        <input type="date" id="dataEvento" />
        <div id="calendar"></div>
      </div>

      <button id="clearFilters" class="btn-limpar">Limpar</button>
    </div>
  </section>

  <section class="carrossel">
    <!-- Carrossel de eventos principais - permanece fixo -->
    <div class="carrossel-container">
      <!-- conteÃºdo do carrossel permanece inalterado -->
    </div>
  </section>

  <section class="eventos-filtrados">
    <div id="eventCards" class="eventos-cards">
      <!-- Cards de eventos renderizados dinamicamente -->
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const estadoContainer = document.getElementById('estadoContainer');
      const tipoEventoSelect = document.getElementById('tipoEvento');
      const nomeInput = document.getElementById('nomeEvento');
      const localInput = document.getElementById('localEvento');
      const dataInput = document.getElementById('dataEvento');
      const clearBtn = document.getElementById('clearFilters');
      const eventCards = document.getElementById('eventCards');

      let eventos = [];

      async function carregarEventos() {
        try {
          const response = await fetch('/api/buscaeventos');
          const data = await response.json();
          eventos = data;
          preencherEstados();
          preencherTipos();
          renderizarCards(eventos);
          marcarDatasComEventos();
        } catch (error) {
          console.error('Erro ao carregar eventos:', error);
        }
      }

      function preencherEstados() {
        const estadosUnicos = [...new Set(eventos.map(e => e.estado))].sort();
        estadoContainer.innerHTML = '';
        estadosUnicos.forEach(estado => {
          const btn = document.createElement('button');
          btn.className = 'estado-option';
          btn.textContent = estado;
          btn.addEventListener('click', () => {
            btn.classList.toggle('active');
            aplicarFiltros();
          });
          estadoContainer.appendChild(btn);
        });
      }

      function preencherTipos() {
        const tiposUnicos = [...new Set(eventos.map(e => e.tipo_evento))].sort();
        tipoEventoSelect.innerHTML = '<option value="">Todos os tipos</option>';
        tiposUnicos.forEach(tipo => {
          const option = document.createElement('option');
          option.value = tipo;
          option.textContent = tipo;
          tipoEventoSelect.appendChild(option);
        });
      }

      function aplicarFiltros() {
        const estadosSelecionados = Array.from(document.querySelectorAll('.estado-option.active')).map(btn => btn.textContent);
        const tipoSelecionado = tipoEventoSelect.value.toLowerCase();
        const nomeBusca = nomeInput.value.toLowerCase();
        const localBusca = localInput.value.toLowerCase();
        const dataSelecionada = dataInput.value;

        const eventosFiltrados = eventos.filter(evento => {
          const estadoMatch = estadosSelecionados.length === 0 || estadosSelecionados.includes(evento.estado);
          const tipoMatch = !tipoSelecionado || evento.tipo_evento.toLowerCase() === tipoSelecionado;
          const nomeMatch = !nomeBusca || evento.nome.toLowerCase().includes(nomeBusca);
          const localMatch = !localBusca || evento.endereco.toLowerCase().includes(localBusca);
          const dataMatch = !dataSelecionada || evento.data === dataSelecionada;
          return estadoMatch && tipoMatch && nomeMatch && localMatch && dataMatch;
        });

        renderizarCards(eventosFiltrados);
      }

      function renderizarCards(listaEventos) {
        eventCards.innerHTML = '';
        if (listaEventos.length === 0) {
          eventCards.innerHTML = '<p>Nenhum evento encontrado.</p>';
          return;
        }

        listaEventos.forEach(evento => {
          const card = document.createElement('div');
          card.className = 'event-card';

          const img = document.createElement('img');
          img.src = evento.imagem ? `data:image/jpeg;base64,${evento.imagem}` : 'caminho/para/imagem_padrao.jpg';
          img.alt = evento.nome;

          const detalhes = document.createElement('div');
          detalhes.className = 'event-details';

          const titulo = document.createElement('h3');
          titulo.textContent = evento.nome;

          const descricao = document.createElement('p');
          descricao.textContent = evento.descricao;

          const data = document.createElement('p');
          data.textContent = `Data: ${evento.data}`;

          const endereco = document.createElement('p');
          endereco.textContent = `Local: ${evento.endereco}`;

          detalhes.appendChild(titulo);
          detalhes.appendChild(descricao);
          detalhes.appendChild(data);
          detalhes.appendChild(endereco);

          card.appendChild(img);
          card.appendChild(detalhes);
          eventCards.appendChild(card);
        });
      }

      function marcarDatasComEventos() {
        const datasComEventos = [...new Set(eventos.map(e => e.data))];
        const calendar = document.getElementById('calendar');
        calendar.innerHTML = '';

        datasComEventos.forEach(data => {
          const dataElement = document.createElement('div');
          dataElement.className = 'calendar-date';
          dataElement.textContent = data;
          dataElement.addEventListener('click', () => {
            dataInput.value = data;
            aplicarFiltros();
          });
          calendar.appendChild(dataElement);
        });
      }

      clearBtn.addEventListener('click', () => {
        document.querySelectorAll('.estado-option.active').forEach(btn => btn.classList.remove('active'));
        tipoEventoSelect.value = '';
        nomeInput.value = '';
        localInput.value = '';
        dataInput.value = '';
        aplicarFiltros();
      });

      tipoEventoSelect.addEventListener('change', aplicarFiltros);
      nomeInput.addEventListener('input', aplicarFiltros);
      localInput.addEventListener('input', aplicarFiltros);
      dataInput.addEventListener('change', aplicarFiltros);

      carregarEventos();
    });
  </script>
</body>

</html>
