<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="css/meusEventosPromotor.css">
    <title>Segue o Festival</title>
    <style>
    .conteudo-secundario {
        width: 90%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .conteudo-secundario-primeiralinha {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 30px;
        justify-content: center;
        margin-top: 30px;
    }

    .evento-container {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: transform 0.3s ease;
    }

    .evento-container:hover {
        transform: translateY(-5px);
    }

    .conteudo-secundario-imagem {
        width: 100%;
        height: 180px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .conteudo-secundario-titulo {
        font-size: 1.2rem;
        color: #333;
        margin-bottom: 10px;
    }

    .conteudo-secundario-paragrafo {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
    }

    .conteudo-secundario-paragrafo i {
        margin-right: 8px;
        color: #4CAF50;
    }

    .evento-acoes {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .botao-editar, .botao-excluir {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .botao-editar {
        background-color: #2196F3;
        color: white;
        margin-right: 10px;
    }

    .botao-editar:hover {
        background-color: #0b7dda;
    }

    .botao-excluir {
        background-color: #f44336;
        color: white;
    }

    .botao-excluir:hover {
        background-color: #da190b;
    }

    /* Responsividade */
    @media (max-width: 768px) {
        .conteudo-secundario-primeiralinha {
            grid-template-columns: 1fr;
        }
        
        .evento-acoes {
            flex-direction: column;
            gap: 10px;
        }
        
        .botao-editar, .botao-excluir {
            width: 100%;
            margin-right: 0;
        }
    }
</style>
</head>
<body>
    <header class="cabecalho">
        <div class="cabecalho-botoes">
            <button class="cabecalho-botao-entrar" onclick="location.href='inserir_eventos.html'">Cadastrar Eventos</button>
            <button class="cabecalho-botao-entrar" onclick="location.href='perfil.html'">Meu Perfil</button>
            <button class="cabecalho-botao-entrar" onclick="location.href='faq.html'">FAQ</button>
        </div>
    </header>

    <main>        
        <a href="https://segue-o-festival.vercel.app/" class="titulo-link"><h1 class="cabecalho-titulo">Segue<br>O Festival!</h1></a>

        <section class="conteudo-secundario">
            <div class="conteudo-secundario-destaque">
                <h1>Meus Eventos</h1>
            </div>
    
            <div class="conteudo-secundario-primeiralinha" id="lista-eventos">
                <!-- Eventos dinâmicos serão inseridos aqui -->
            </div>
        </section>

        <footer class="rodape">
            <h3 class="titulo-rodape">Segue<br>O Festival!</h3>                     
            <div class="direitos-reservados">
              &copy; 2025 Segue o Festival. Todos os direitos reservados.
            </div>            
        </footer>
    </main>

    <script>
        // Função para formatar a data no padrão dd/MM/yyyy
        function formatarData(dataISO) {
            const data = new Date(dataISO);
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        // Função para carregar os eventos do promotor
        async function carregarEventos() {
            // Recupera o CNPJ do usuário logado
            const cnpjUsuario = localStorage.getItem("cnpjUsuario");

            if (!cnpjUsuario) {
                document.getElementById("lista-eventos").innerHTML = "<p>Erro: Usuário não identificado. Faça login novamente.</p>";
                console.error("Erro: CNPJ não encontrado no LocalStorage.");
                return;
            }

            try {
                // Exibe loading enquanto carrega
                document.getElementById("lista-eventos").innerHTML = "<p>Carregando seus eventos...</p>";
                
                // Faz requisição para buscar os eventos do usuário logado
                const resposta = await fetch(`https://segue-o-festival.vercel.app/api/meusEventosPromotor?cnpj=${cnpjUsuario}`);

                if (!resposta.ok) {
                    throw new Error("Erro ao carregar eventos. Código: " + resposta.status);
                }

                const eventos = await resposta.json();
                const listaEventos = document.getElementById("lista-eventos");

                // Limpa os eventos antes de adicionar os novos
                listaEventos.innerHTML = "";

                if (eventos.length === 0) {
                    listaEventos.innerHTML = `
                        <div class="sem-eventos">
                            <p>Nenhum evento encontrado.</p>
                            <button onclick="location.href='inserir_eventos.html'" class="botao-cadastrar">
                                Cadastrar Primeiro Evento
                            </button>
                        </div>
                    `;
                    return;
                }

                // Renderiza os eventos com botões de ação
                eventos.forEach(evento => {
                    const eventoDiv = document.createElement("div");
                    eventoDiv.className = "evento-container";
                    eventoDiv.dataset.id = evento.id_evento;

                    eventoDiv.innerHTML = `
                        <img class="conteudo-secundario-imagem" src="${evento.imagem || 'img/placeholder-eventos.jpg'}" alt="Banner ${evento.nome}">
                        <h3 class="conteudo-secundario-titulo">${evento.nome}</h3>
                        <p class="conteudo-secundario-paragrafo"><i class="fas fa-calendar-alt"></i> ${formatarData(evento.data)}</p>
                        <p class="conteudo-secundario-paragrafo"><i class="fas fa-map-marker-alt"></i> ${evento.endereco}</p>
                        <div class="evento-acoes">
                            <button class="botao-editar" onclick="editarEvento(${evento.id_evento})">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="botao-excluir" onclick="confirmarExclusao(${evento.id_evento})">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    
                    listaEventos.appendChild(eventoDiv);
                });

            } catch (error) {
                console.error("Erro na requisição:", error);
                document.getElementById("lista-eventos").innerHTML = `
                    <div class="erro-carregamento">
                        <p>Erro ao carregar eventos. ${error.message}</p>
                        <button onclick="carregarEventos()" class="botao-tentar-novamente">
                            <i class="fas fa-sync-alt"></i> Tentar Novamente
                        </button>
                    </div>
                `;
            }
        }

        // Função para excluir um evento
        async function excluirEvento(idEvento) {
            const cnpjUsuario = localStorage.getItem("cnpjUsuario");
            
            try {
                const resposta = await fetch(`https://segue-o-festival.vercel.app/api/meusEventosPromotor?cnpj=${cnpjUsuario}&id_evento=${idEvento}`, {
                    method: 'DELETE'
                });

                if (!resposta.ok) {
                    const erro = await resposta.json();
                    throw new Error(erro.message || "Erro ao excluir evento.");
                }

                const resultado = await resposta.json();
                alert(resultado.message || "Evento excluído com sucesso!");
                carregarEventos(); // Recarrega a lista de eventos
                
            } catch (error) {
                console.error("Erro:", error);
                alert(error.message || "Erro ao excluir evento. Tente novamente.");
            }
        }

        // Função para confirmar a exclusão
        function confirmarExclusao(idEvento) {
            if (confirm("Tem certeza que deseja excluir este evento?\nEsta ação não pode ser desfeita.")) {
                excluirEvento(idEvento);
            }
        }

        // Função para editar um evento
        function editarEvento(idEvento) {
            window.location.href = `editar_evento.html?id=${idEvento}`;
        }

        // Carrega os eventos quando a página é aberta
        document.addEventListener("DOMContentLoaded", carregarEventos);
    </script>
</body>
</html>
