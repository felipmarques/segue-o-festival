<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
    <link rel="stylesheet" href="css/meusEventosPromotor.css">
    <title>Segue o Festival - Meus Eventos</title>
    <style>
        /* Estilos do cabeçalho */
        .cabecalho {
            background-color: #fff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cabecalho-botoes {
            display: flex;
            gap: 1rem;
        }

        .cabecalho-botao-entrar {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .cabecalho-botao-entrar:hover {
            background-color: #3e8e41;
        }

        /* Botão de logout */
        .botao-logout {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .botao-logout:hover {
            background-color: #d32f2f;
        }

        /* Estilos dos cards de eventos */
        .evento-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .conteudo-secundario-imagem {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .conteudo-secundario-titulo {
            font-size: 1.3rem;
            color: #2c3e50;
            margin: 0 0 0.5rem 0;
            font-weight: 600;
        }

        .conteudo-secundario-paragrafo {
            font-size: 0.95rem;
            color: #555;
            margin: 0.3rem 0;
            line-height: 1.4;
            display: flex;
            align-items: center;
        }

        .conteudo-secundario-paragrafo i {
            margin-right: 8px;
            color: #4CAF50;
        }

        /* Botões de ação */
        .evento-acoes {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .botao-editar, .botao-excluir {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 5px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .botao-editar {
            background-color: #2196F3;
            color: white;
        }

        .botao-excluir {
            background-color: #f44336;
            color: white;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #4CAF50;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mensagens */
        .mensagem-container {
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }

        .mensagem-erro {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .mensagem-sucesso {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .mensagem-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .cabecalho {
                flex-direction: column;
                gap: 1rem;
            }
            
            .cabecalho-botoes {
                width: 100%;
                justify-content: space-between;
            }
            
            .evento-card {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="cabecalho">
        <div class="cabecalho-botoes">
            <button class="cabecalho-botao-entrar" onclick="location.href='inserir_eventos.html'">Cadastrar Eventos</button>
            <button class="cabecalho-botao-entrar" onclick="location.href='perfil.html'">Meu Perfil</button>
            <button class="cabecalho-botao-entrar" onclick="location.href='faq.html'">FAQ</button>
            <button class="cabecalho-botao-entrar" onclick="location.href='galeria.html'">Galeria de Fotos</button>
        </div>
        <button class="botao-logout" onclick="fazerLogout()">
            <i class="fas fa-sign-out-alt"></i> Sair
        </button>
    </header>

    <main>        
        <a href="https://segue-o-festival.vercel.app/" class="titulo-link"><h1 class="cabecalho-titulo">Segue<br>O Festival!</h1></a>

        <section class="conteudo-secundario">
            <div class="conteudo-secundario-destaque">
                <h1>Meus Eventos</h1>
            </div>
    
            <div class="conteudo-secundario-primeiralinha" id="lista-eventos">
                <div class="loading-spinner"></div>
            </div>
        </section>

        <footer class="rodape">
            <h3 class="titulo-rodape">Segue<br>O Festival!</h3>                     
            <div class="direitos-reservados">
              &copy; 2025 Segue o Festival. Todos os direitos reservados.
            </div>            
        </footer>
    </main>

    <script>
        // Funções auxiliares de autenticação
        function getUsuarioLogado() {
            const usuario = localStorage.getItem("usuarioLogado");
            if (!usuario) return null;
            
            try {
                return JSON.parse(usuario);
            } catch (e) {
                console.error("Erro ao parsear usuário:", e);
                return null;
            }
        }

        function usuarioEstaLogado() {
            const usuario = getUsuarioLogado();
            return usuario && usuario.cnpj && usuario.email;
        }

        function getCnpjUsuario() {
            const usuario = getUsuarioLogado();
            return usuario ? usuario.cnpj : null;
        }

        // Função para formatar a data
        function formatarData(dataISO) {
            if (!dataISO) return "Data não definida";
            
            try {
                const data = new Date(dataISO);
                if (isNaN(data.getTime())) return "Data inválida";
                
                const dia = String(data.getDate()).padStart(2, '0');
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const ano = data.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } catch (error) {
                console.error("Erro ao formatar data:", error);
                return "Data inválida";
            }
        }

        // Função de logout
        function fazerLogout() {
            localStorage.removeItem("usuarioLogado");
            window.location.href = "index.html";
        }

        // Função para exibir mensagem na lista de eventos
        function exibirMensagem(tipo, mensagem, botao = null) {
            const listaEventos = document.getElementById("lista-eventos");
            let html = `<div class="mensagem-container mensagem-${tipo}">${mensagem}</div>`;
            
            if (botao) {
                html += botao;
            }
            
            listaEventos.innerHTML = html;
        }

        // Função principal para carregar os eventos
        async function carregarEventos() {
            const listaEventos = document.getElementById("lista-eventos");
            
            // Verificar autenticação
            if (!usuarioEstaLogado()) {
                exibirMensagem("erro", "Você precisa estar logado para acessar esta página.", 
                    `<button class="cabecalho-botao-entrar" onclick="window.location.href='login_promotor.html'">
                        Ir para Login
                    </button>`);
                return;
            }

            const cnpjUsuario = getCnpjUsuario();
            
            // Mostrar loading
            listaEventos.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                // Chamada à API
                const resposta = await fetch(`https://segue-o-festival.vercel.app/api/eventos?cnpj=${cnpjUsuario}`);
                
                // Tratar erros HTTP
                if (!resposta.ok) {
                    const erro = await resposta.text();
                    throw new Error(erro || `Erro ${resposta.status}: ${resposta.statusText}`);
                }
                
                const eventos = await resposta.json();
                
                // Verificar se há eventos
                if (!eventos || eventos.length === 0) {
                    exibirMensagem("sucesso", "Você ainda não cadastrou nenhum evento.", 
                        `<button class="cabecalho-botao-entrar" onclick="location.href='inserir_eventos.html'">
                            Cadastrar Primeiro Evento
                        </button>`);
                    return;
                }
                
                // Exibir eventos
                listaEventos.innerHTML = "";
                eventos.forEach(evento => {
                    const eventoDiv = document.createElement("div");
                    eventoDiv.className = "evento-card";
                    eventoDiv.innerHTML = `
                        <img class="conteudo-secundario-imagem" src="${evento.imagem || 'img/placeholder-eventos.jpg'}" 
                             alt="Banner ${evento.nome || 'Evento'}">
                        <h3 class="conteudo-secundario-titulo">${evento.nome || 'Nome do Evento'}</h3>
                        <p class="conteudo-secundario-paragrafo">
                            <i class="fas fa-calendar-alt"></i> ${formatarData(evento.data)}
                        </p>
                        <p class="conteudo-secundario-paragrafo">
                            <i class="fas fa-map-marker-alt"></i> ${evento.endereco || 'Local não informado'}
                        </p>
                        <div class="evento-acoes">
                            <button class="botao-editar" onclick="editarEvento('${evento.id_evento}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="botao-excluir" onclick="confirmarExclusao('${evento.id_evento}')">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                        </div>
                    `;
                    listaEventos.appendChild(eventoDiv);
                });
                
            } catch (error) {
                console.error("Erro ao carregar eventos:", error);
                exibirMensagem("erro", `Erro ao carregar eventos: ${error.message}`, 
                    `<button class="cabecalho-botao-entrar" onclick="carregarEventos()">
                        Tentar Novamente
                    </button>`);
            }
        }

        // Funções para edição e exclusão
        function editarEvento(idEvento) {
            window.location.href = `editar_evento.html?id=${idEvento}`;
        }

        function confirmarExclusao(idEvento) {
            if (confirm("Tem certeza que deseja excluir este evento?\nEsta ação não pode ser desfeita.")) {
                excluirEvento(idEvento);
            }
        }

        async function excluirEvento(idEvento) {
            try {
                const cnpjUsuario = getCnpjUsuario();
                if (!cnpjUsuario) {
                    throw new Error("Usuário não autenticado");
                }
                
                const resposta = await fetch(`https://segue-o-festival.vercel.app/api/eventos/${idEvento}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cnpj: cnpjUsuario })
                });
                
                if (!resposta.ok) {
                    const erro = await resposta.text();
                    throw new Error(erro || `Erro ${resposta.status}: ${resposta.statusText}`);
                }
                
                alert("Evento excluído com sucesso!");
                carregarEventos();
                
            } catch (error) {
                console.error("Erro ao excluir evento:", error);
                alert(`Falha ao excluir evento: ${error.message}`);
            }
        }

        // Inicialização
        document.addEventListener("DOMContentLoaded", function() {
            if (!usuarioEstaLogado()) {
                window.location.href = "login_promotor.html";
            } else {
                carregarEventos();
            }
        });
    </script>
</body>
</html>
